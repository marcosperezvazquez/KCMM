<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Classroom Rewards</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection, addDoc, deleteDoc, query, getDocs, serverTimestamp, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signOut, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // --- CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyB24FK40HnQ_EVKZkmBiCvMXU7wFOQ6WOI",
            authDomain: "gemini-test-aa0b7.firebaseapp.com",
            projectId: "gemini-test-aa0b7",
            storageBucket: "gemini-test-aa0b7.appspot.com",
            messagingSenderId: "410596219691",
            appId: "1:410596219691:web:d3ec379735ea279fbe436e",
            measurementId: "G-MDZXM0ZDSF"
        };
        const appId = firebaseConfig.projectId;
        const TEACHER_EMAIL = "teacher@example.com"; // A dummy email for teacher login
        const TEACHER_PASSWORD = "teacher-password-01"; // A dummy password for teacher login

        // --- FIREBASE INITIALIZATION ---
        let app, db, auth;
        let studentDataUnsubscribe, shopDataUnsubscribe, allStudentsUnsubscribe, purchaseHistoryUnsubscribe;

        // --- UI ELEMENTS ---
        let loginView, studentView, teacherView, loadingOverlay, modal, modalMessage, modalClose, registrationView;

        // --- HELPER FUNCTIONS ---
        function showLoading(show) { if (loadingOverlay) loadingOverlay.style.display = show ? 'flex' : 'none'; }
        function showModal(message) { if (modal && modalMessage) { modalMessage.textContent = message; modal.style.display = 'flex'; } }
        function hideModal() { if (modal) modal.style.display = 'none'; }
        function showView(view) {
            [loginView, studentView, teacherView, registrationView].forEach(v => v.classList.add('hidden'));
            view.classList.remove('hidden');
        }
        
        // --- DATA PATHS ---
        const getStudentsCollectionRef = () => collection(db, `classroom-rewards/${appId}/students`);
        const getStudentDocRef = (studentId) => doc(db, `classroom-rewards/${appId}/students/${studentId}`);
        const getShopCollectionRef = () => collection(db, `classroom-rewards/${appId}/shop`);
        const getShopItemDocRef = (itemId) => doc(db, `classroom-rewards/${appId}/shop/${itemId}`);
        const getPurchaseHistoryCollectionRef = () => collection(db, `classroom-rewards/${appId}/purchase_history`);

        // --- TEACHER VIEW LOGIC ---
        async function loadTeacherDashboard() {
            showView(teacherView);
            // Listeners for students, shop, and history
            if (allStudentsUnsubscribe) allStudentsUnsubscribe();
            allStudentsUnsubscribe = onSnapshot(getStudentsCollectionRef(), (snapshot) => {
                const students = [];
                snapshot.forEach(doc => students.push({ id: doc.id, ...doc.data() }));
                renderTeacherStudentList(students);
            });
            if (shopDataUnsubscribe) shopDataUnsubscribe();
            shopDataUnsubscribe = onSnapshot(getShopCollectionRef(), (snapshot) => {
                const items = [];
                snapshot.forEach(doc => items.push({ id: doc.id, ...doc.data() }));
                renderTeacherShopList(items);
            });
            if (purchaseHistoryUnsubscribe) purchaseHistoryUnsubscribe();
            purchaseHistoryUnsubscribe = onSnapshot(query(getPurchaseHistoryCollectionRef()), (snapshot) => {
                const history = [];
                snapshot.forEach(doc => history.push(doc.data()));
                history.sort((a, b) => (b.timestamp?.toMillis() || 0) - (a.timestamp?.toMillis() || 0));
                renderPurchaseHistory(history);
            });
        }

        function renderTeacherStudentList(students) {
            const container = document.getElementById('teacher-student-list');
            container.innerHTML = '';
            if (students.length === 0) { container.innerHTML = `<p class="text-gray-500">No students have been added yet.</p>`; return; }
            students.forEach(student => {
                const studentEl = document.createElement('div');
                studentEl.className = 'p-4 bg-white rounded-lg shadow-md';
                let registrationInfo = student.isClaimed
                    ? `<p class="text-sm text-green-600 font-semibold">Account Claimed</p>`
                    : `<p class="text-sm text-red-600 font-semibold">Registration Code: <code class="bg-red-100 p-1 rounded">${student.registrationCode}</code></p>`;

                studentEl.innerHTML = `
                    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
                        <div class="flex-grow">
                            <p class="font-bold text-lg text-gray-800">${student.name}</p>
                            ${registrationInfo}
                            <p class="text-sm text-blue-600 font-semibold">XP: ${student.xp || 0} | Money: $${student.money || 0}</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <input type="number" placeholder="Add/Sub XP & $" class="w-28 p-2 border rounded-md focus:ring-2 focus:ring-indigo-500">
                            <button class="update-xp-btn bg-indigo-500 text-white px-3 py-2 rounded-md hover:bg-indigo-600">Update</button>
                        </div>
                    </div>
                `;
                container.appendChild(studentEl);
                studentEl.querySelector('.update-xp-btn').addEventListener('click', async () => {
                    const amountInput = studentEl.querySelector('input[type="number"]');
                    const amount = parseInt(amountInput.value, 10);
                    if (isNaN(amount)) { showModal("Please enter a valid number."); return; }
                    showLoading(true);
                    try {
                        const studentDoc = await getDoc(getStudentDocRef(student.id));
                        if (studentDoc.exists()) {
                            const currentXp = studentDoc.data().xp || 0;
                            const currentMoney = studentDoc.data().money || 0;
                            await updateDoc(getStudentDocRef(student.id), { xp: currentXp + amount, money: currentMoney + amount });
                            amountInput.value = '';
                        }
                    } catch (error) { console.error("Error updating points:", error); showModal("Failed to update points."); }
                    finally { showLoading(false); }
                });
            });
        }
        
        function renderTeacherShopList(items) { /* Unchanged */ }
        function renderPurchaseHistory(history) { /* Unchanged */ }

        // --- STUDENT VIEW LOGIC ---
        async function loadStudentDashboard(uid) {
            showView(studentView);
            if (studentDataUnsubscribe) studentDataUnsubscribe();
            studentDataUnsubscribe = onSnapshot(getStudentDocRef(uid), (doc) => {
                if (doc.exists()) {
                    const student = { id: doc.id, ...doc.data() };
                    renderStudentHeader(student);
                    getDocs(getShopCollectionRef()).then(shopSnapshot => {
                         const items = [];
                         shopSnapshot.forEach(doc => items.push({ id: doc.id, ...doc.data() }));
                         renderStudentShop(items, student);
                    });
                }
            });
        }

        function renderStudentHeader(student) { /* Unchanged */ }
        function renderStudentShop(items, student) { /* Unchanged, uses secure purchase logic */ }

        // --- AUTH & LOGIN LOGIC ---
        function logout() {
            if (studentDataUnsubscribe) studentDataUnsubscribe();
            if (shopDataUnsubscribe) shopDataUnsubscribe();
            if (allStudentsUnsubscribe) allStudentsUnsubscribe();
            if (purchaseHistoryUnsubscribe) purchaseHistoryUnsubscribe();
            signOut(auth);
        }

        // --- EVENT LISTENERS & APP START ---
        document.addEventListener('DOMContentLoaded', () => {
            // Assign UI Elements
            loginView = document.getElementById('login-view');
            studentView = document.getElementById('student-view');
            teacherView = document.getElementById('teacher-view');
            registrationView = document.getElementById('registration-view');
            loadingOverlay = document.getElementById('loading-overlay');
            modal = document.getElementById('modal');
            modalMessage = document.getElementById('modal-message');
            modalClose = document.getElementById('modal-close');

            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            onAuthStateChanged(auth, async user => {
                showLoading(true);
                if (user) {
                    if (user.email === TEACHER_EMAIL) {
                        await loadTeacherDashboard();
                    } else {
                        await loadStudentDashboard(user.uid);
                    }
                } else {
                    showView(loginView);
                }
                showLoading(false);
            });
            
            modalClose.addEventListener('click', hideModal);
            document.getElementById('show-registration-btn').addEventListener('click', () => showView(registrationView));
            document.getElementById('show-login-btn').addEventListener('click', () => showView(loginView));
            document.querySelectorAll('.logout-btn').forEach(btn => btn.addEventListener('click', logout));
            
            // Login Form
            document.getElementById('login-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                showLoading(true);
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (error) {
                    console.error("Login failed:", error);
                    showModal("Login failed. Please check your email and password.");
                } finally {
                    showLoading(false);
                }
            });

            // Registration Form
            document.getElementById('registration-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const code = document.getElementById('registration-code').value.trim();
                const email = document.getElementById('registration-email').value.trim();
                const password = document.getElementById('registration-password').value;
                if (password.length < 6) {
                    showModal("Password must be at least 6 characters long.");
                    return;
                }
                showLoading(true);
                try {
                    // Find student document with this registration code
                    const q = query(getStudentsCollectionRef(), where("registrationCode", "==", code));
                    const querySnapshot = await getDocs(q);

                    if (querySnapshot.empty) {
                        showModal("Invalid Registration Code.");
                        showLoading(false);
                        return;
                    }

                    const studentDoc = querySnapshot.docs[0];
                    if (studentDoc.data().isClaimed) {
                        showModal("This Registration Code has already been used.");
                        showLoading(false);
                        return;
                    }
                    
                    // Create the user in Firebase Auth
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    const user = userCredential.user;

                    // This part is tricky. We need to move the data to a new document with the user's UID as the ID.
                    const batch = writeBatch(db);
                    const oldDocRef = studentDoc.ref;
                    const newDocRef = getStudentDocRef(user.uid);
                    
                    const studentData = studentDoc.data();
                    const updatedData = {
                        ...studentData,
                        isClaimed: true,
                        registrationCode: null, // Remove the code
                        email: email
                    };
                    
                    batch.set(newDocRef, updatedData); // Create the new document
                    batch.delete(oldDocRef); // Delete the old temporary document
                    
                    await batch.commit();
                    // onAuthStateChanged will now log the user in and load their dashboard.

                } catch (error) {
                    console.error("Registration failed:", error);
                    if (error.code === 'auth/email-already-in-use') {
                        showModal("This email address is already in use.");
                    } else {
                        showModal("Registration failed. Please try again.");
                    }
                } finally {
                    showLoading(false);
                }
            });

            // Teacher: Add New Student
            document.getElementById('add-student-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const studentNameInput = document.getElementById('new-student-name');
                const name = studentNameInput.value.trim();
                if (!name) { showModal("Please enter a student name."); return; }
                showLoading(true);
                try {
                    // Generate a simple random code
                    const registrationCode = Math.random().toString(36).substring(2, 8).toUpperCase();
                    await addDoc(getStudentsCollectionRef(), { 
                        name: name, 
                        xp: 0, 
                        money: 0,
                        isClaimed: false,
                        registrationCode: registrationCode
                    });
                    studentNameInput.value = '';
                    showModal(`Student "${name}" added!`);
                } catch (error) {
                    console.error("Error adding student:", error);
                    showModal("Failed to add student.");
                } finally {
                    showLoading(false);
                }
            });
            
            // Teacher: Add Item
            document.getElementById('add-item-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const itemNameInput = document.getElementById('new-item-name');
                const itemPriceInput = document.getElementById('new-item-price');
                const name = itemNameInput.value.trim();
                const price = parseInt(itemPriceInput.value, 10);
                if (!name || isNaN(price) || price < 0) { showModal("Invalid item details."); return; }
                showLoading(true);
                try {
                    await addDoc(getShopCollectionRef(), { name, price });
                    itemNameInput.value = ''; itemPriceInput.value = '';
                } catch (error) {
                    console.error("Error adding item:", error);
                    showModal("Failed to add shop item.");
                } finally {
                    showLoading(false);
                }
            });
        });
    </script>
    <style> body { font-family: 'Inter', sans-serif; } .hidden { display: none; } </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-7xl">
        <!-- Login View -->
        <div id="login-view">
            <div class="max-w-md mx-auto mt-20 bg-white p-8 rounded-xl shadow-lg">
                <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">Login</h1>
                <form id="login-form">
                    <div class="mb-4">
                        <label for="login-email" class="block text-sm font-medium text-gray-700">Email</label>
                        <input type="email" id="login-email" class="mt-1 w-full p-3 border rounded-lg" required>
                    </div>
                    <div class="mb-6">
                        <label for="login-password" class="block text-sm font-medium text-gray-700">Password</label>
                        <input type="password" id="login-password" class="mt-1 w-full p-3 border rounded-lg" required>
                    </div>
                    <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-lg hover:bg-indigo-700">Login</button>
                </form>
                <p class="text-center mt-4 text-sm">
                    First time here? 
                    <button id="show-registration-btn" class="font-semibold text-indigo-600 hover:underline">Register your account</button>
                </p>
            </div>
        </div>

        <!-- Registration View -->
        <div id="registration-view" class="hidden">
             <div class="max-w-md mx-auto mt-20 bg-white p-8 rounded-xl shadow-lg">
                <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">Register Your Account</h1>
                <form id="registration-form">
                    <div class="mb-4">
                        <label for="registration-code" class="block text-sm font-medium text-gray-700">Registration Code</label>
                        <input type="text" id="registration-code" class="mt-1 w-full p-3 border rounded-lg" placeholder="Code from your teacher" required>
                    </div>
                    <div class="mb-4">
                        <label for="registration-email" class="block text-sm font-medium text-gray-700">Your Email</label>
                        <input type="email" id="registration-email" class="mt-1 w-full p-3 border rounded-lg" required>
                    </div>
                    <div class="mb-6">
                        <label for="registration-password" class="block text-sm font-medium text-gray-700">Create a Password</label>
                        <input type="password" id="registration-password" class="mt-1 w-full p-3 border rounded-lg" placeholder="At least 6 characters" required>
                    </div>
                    <button type="submit" class="w-full bg-green-600 text-white font-bold py-3 rounded-lg hover:bg-green-700">Create Account</button>
                </form>
                 <p class="text-center mt-4 text-sm">
                    Already have an account? 
                    <button id="show-login-btn" class="font-semibold text-indigo-600 hover:underline">Login here</button>
                </p>
            </div>
        </div>

        <!-- Student View -->
        <div id="student-view" class="hidden">
            <header class="bg-white p-6 rounded-xl shadow-lg mb-8 flex flex-col sm:flex-row justify-between items-center">
                <h1 class="text-3xl font-bold text-gray-800">Welcome, <span id="student-name"></span>!</h1>
                <div class="flex items-center gap-6 mt-4 sm:mt-0">
                    <div class="text-center"><p class="text-sm text-gray-500">XP</p><p class="text-3xl font-bold text-green-500" id="student-xp">0</p></div>
                    <div class="text-center"><p class="text-sm text-gray-500">Money</p><p class="text-3xl font-bold text-blue-500" id="student-money">0</p></div>
                    <button class="logout-btn bg-red-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-600">Logout</button>
                </div>
            </header>
            <div>
                <h2 class="text-2xl font-bold text-gray-700 mb-6">Class Shop</h2>
                <div id="student-shop-container" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"></div>
            </div>
        </div>

        <!-- Teacher View -->
        <div id="teacher-view" class="hidden">
            <header class="bg-white p-6 rounded-xl shadow-lg mb-8 flex justify-between items-center">
                <h1 class="text-3xl font-bold text-gray-800">Teacher Dashboard</h1>
                <button class="logout-btn bg-red-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-600">Logout</button>
            </header>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <section class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold text-gray-700 mb-4">Manage Students</h2>
                    <div id="teacher-student-list" class="space-y-4 mb-6"></div>
                     <form id="add-student-form" class="mt-6 pt-6 border-t">
                         <h3 class="text-lg font-semibold text-gray-700 mb-2">Add New Student</h3>
                         <div class="flex gap-2">
                            <input type="text" id="new-student-name" class="flex-grow p-2 border rounded-md" placeholder="Student's Full Name">
                            <button type="submit" class="bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600">Add Student</button>
                         </div>
                    </form>
                </section>
                <div class="space-y-8">
                    <section class="bg-white p-6 rounded-xl shadow-lg">
                        <h2 class="text-2xl font-bold text-gray-700 mb-4">Manage Shop</h2>
                        <div id="teacher-shop-list" class="space-y-4 mb-6"></div>
                        <form id="add-item-form" class="mt-6 pt-6 border-t">
                             <h3 class="text-lg font-semibold text-gray-700 mb-2">Add New Item</h3>
                             <div class="flex flex-col gap-2">
                                <input type="text" id="new-item-name" class="p-2 border rounded-md" placeholder="Item Name">
                                <input type="number" id="new-item-price" class="p-2 border rounded-md" placeholder="Price $">
                                <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600">Add Item</button>
                             </div>
                        </form>
                    </section>
                    <section class="bg-white p-6 rounded-xl shadow-lg">
                        <h2 class="text-2xl font-bold text-gray-700 mb-4">Purchase History</h2>
                        <div id="purchase-history-list" class="space-y-2 max-h-96 overflow-y-auto"></div>
                    </section>
                </div>
            </div>
        </div>
    </div>
    <div id="loading-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"><div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-white"></div></div>
    <div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"><div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center"><p id="modal-message" class="text-lg text-gray-800 mb-4"></p><button id="modal-close" class="bg-indigo-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-indigo-700">Close</button></div></div>
</body>
</html>
