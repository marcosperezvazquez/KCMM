<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Classroom Rewards</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection, addDoc, deleteDoc, query, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // --- CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyB24FK40HnQ_EVKZkmBiCvMXU7wFOQ6WOI",
            authDomain: "gemini-test-aa0b7.firebaseapp.com",
            projectId: "gemini-test-aa0b7",
            storageBucket: "gemini-test-aa0b7.appspot.com",
            messagingSenderId: "410596219691",
            appId: "1:410596219691:web:d3ec379735ea279fbe436e",
            measurementId: "G-MDZXM0ZDSF"
        };
        const appId = firebaseConfig.projectId;

        // --- FIREBASE INITIALIZATION ---
        let app, db, auth;
        let currentUser = null;
        let studentDataUnsubscribe = null;
        let shopDataUnsubscribe = null;
        let allStudentsUnsubscribe = null;
        let purchaseHistoryUnsubscribe = null;

        // --- UI ELEMENTS ---
        let loginView, studentView, teacherView, loadingOverlay, modal, modalMessage, modalClose;

        // --- HELPER FUNCTIONS ---
        function showLoading(show) { if (loadingOverlay) loadingOverlay.style.display = show ? 'flex' : 'none'; }
        function showModal(message) { if (modal && modalMessage) { modalMessage.textContent = message; modal.style.display = 'flex'; } }
        function hideModal() { if (modal) modal.style.display = 'none'; }
        function showView(view) {
            [loginView, studentView, teacherView].forEach(v => v.classList.add('hidden'));
            view.classList.remove('hidden');
        }
        
        // --- DATA PATHS ---
        const getStudentsCollectionRef = () => collection(db, `classroom-rewards/${appId}/students`);
        const getStudentDocRef = (studentId) => doc(db, `classroom-rewards/${appId}/students/${studentId}`);
        const getShopCollectionRef = () => collection(db, `classroom-rewards/${appId}/shop`);
        const getShopItemDocRef = (itemId) => doc(db, `classroom-rewards/${appId}/shop/${itemId}`);
        const getPurchaseHistoryCollectionRef = () => collection(db, `classroom-rewards/${appId}/purchase_history`);
        const getTeacherDocRef = (teacherId) => doc(db, `teachers/${teacherId}`);

        // --- TEACHER VIEW LOGIC ---
        async function loadTeacherDashboard() {
            showView(teacherView);
            document.getElementById('teacher-uid-display').innerHTML = `Your Teacher UID is: <code class="bg-gray-200 p-1 rounded-md">${auth.currentUser.uid}</code>. Add this to the 'teachers' collection in Firestore to grant yourself write access.`;
            
            if (allStudentsUnsubscribe) allStudentsUnsubscribe();
            allStudentsUnsubscribe = onSnapshot(getStudentsCollectionRef(), (snapshot) => {
                const students = [];
                snapshot.forEach(doc => students.push({ id: doc.id, ...doc.data() }));
                renderTeacherStudentList(students);
            });

            if (shopDataUnsubscribe) shopDataUnsubscribe();
            shopDataUnsubscribe = onSnapshot(getShopCollectionRef(), (snapshot) => {
                const items = [];
                snapshot.forEach(doc => items.push({ id: doc.id, ...doc.data() }));
                renderTeacherShopList(items);
            });

            if (purchaseHistoryUnsubscribe) purchaseHistoryUnsubscribe();
            purchaseHistoryUnsubscribe = onSnapshot(query(getPurchaseHistoryCollectionRef()), (snapshot) => {
                const history = [];
                snapshot.forEach(doc => history.push(doc.data()));
                history.sort((a, b) => b.timestamp.toMillis() - a.timestamp.toMillis());
                renderPurchaseHistory(history);
            });
        }

        function renderTeacherStudentList(students) {
            const container = document.getElementById('teacher-student-list');
            container.innerHTML = '';
            if (students.length === 0) { container.innerHTML = `<p class="text-gray-500">No students have signed up yet.</p>`; return; }
            students.forEach(student => {
                const studentEl = document.createElement('div');
                studentEl.className = 'p-4 bg-white rounded-lg shadow-md flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4';
                studentEl.innerHTML = `
                    <div class="flex-grow">
                        <p class="font-bold text-lg text-gray-800">${student.name}</p>
                        <p class="text-sm text-green-600 font-semibold">XP: ${student.xp || 0} | Money: $${student.money || 0}</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <input type="number" placeholder="Add/Sub XP & $" class="w-28 p-2 border rounded-md focus:ring-2 focus:ring-indigo-500">
                        <button class="update-xp-btn bg-indigo-500 text-white px-3 py-2 rounded-md hover:bg-indigo-600">Update</button>
                    </div>
                `;
                container.appendChild(studentEl);
                studentEl.querySelector('.update-xp-btn').addEventListener('click', async () => {
                    const amountInput = studentEl.querySelector('input[type="number"]');
                    const amount = parseInt(amountInput.value, 10);
                    if (isNaN(amount)) { showModal("Please enter a valid number."); return; }
                    showLoading(true);
                    try {
                        const studentDoc = await getDoc(getStudentDocRef(student.id));
                        if (studentDoc.exists()) {
                            const currentXp = studentDoc.data().xp || 0;
                            const currentMoney = studentDoc.data().money || 0;
                            await updateDoc(getStudentDocRef(student.id), { xp: currentXp + amount, money: currentMoney + amount });
                            amountInput.value = '';
                        }
                    } catch (error) { console.error("Error updating points:", error); showModal("Failed to update points. Check your security rules."); }
                    finally { showLoading(false); }
                });
            });
        }
        
        function renderTeacherShopList(items) {
            const container = document.getElementById('teacher-shop-list');
            container.innerHTML = '';
            items.forEach(item => {
                const itemEl = document.createElement('div');
                itemEl.className = 'p-4 bg-white rounded-lg shadow-md flex items-center justify-between gap-4';
                itemEl.innerHTML = `
                    <div>
                        <p class="font-bold text-lg text-gray-800">${item.name}</p>
                        <p class="text-sm text-blue-600 font-semibold">Price: $${item.price}</p>
                    </div>
                    <button class="delete-item-btn bg-red-500 text-white px-3 py-2 rounded-md hover:bg-red-600 transition-colors">Delete</button>
                `;
                container.appendChild(itemEl);
                itemEl.querySelector('.delete-item-btn').addEventListener('click', async () => {
                    showLoading(true);
                    try { await deleteDoc(getShopItemDocRef(item.id)); }
                    catch (error) { console.error("Error deleting item:", error); showModal("Failed to delete item."); }
                    finally { showLoading(false); }
                });
            });
        }

        function renderPurchaseHistory(history) {
             const container = document.getElementById('purchase-history-list');
            container.innerHTML = '';
            if (history.length === 0) { container.innerHTML = `<p class="text-gray-500">No purchases have been made yet.</p>`; return; }
            history.forEach(purchase => {
                const itemEl = document.createElement('div');
                itemEl.className = 'p-3 bg-gray-50 rounded-md';
                itemEl.innerHTML = `
                    <p class="font-semibold">${purchase.studentName} <span class="font-normal">bought</span> ${purchase.itemName}</p>
                    <p class="text-xs text-gray-500">${new Date(purchase.timestamp.toMillis()).toLocaleString()}</p>
                `;
                container.appendChild(itemEl);
            });
        }

        // --- STUDENT VIEW LOGIC ---
        async function loadStudentDashboard(uid) {
            const studentRef = getStudentDocRef(uid);
            let studentDoc = await getDoc(studentRef);

            if (!studentDoc.exists()) {
                // First-time sign-in, create their account automatically
                await setDoc(studentRef, {
                    name: currentUser.displayName,
                    xp: 0,
                    money: 0
                });
                studentDoc = await getDoc(studentRef); // Re-fetch the new doc
            }
            showView(studentView);
            
            if (studentDataUnsubscribe) studentDataUnsubscribe();
            studentDataUnsubscribe = onSnapshot(studentRef, (doc) => {
                if (doc.exists()) {
                    const student = { id: doc.id, ...doc.data() };
                    renderStudentHeader(student);
                    getDocs(getShopCollectionRef()).then(shopSnapshot => {
                         const items = [];
                         shopSnapshot.forEach(doc => items.push({ id: doc.id, ...doc.data() }));
                         renderStudentShop(items, student);
                    });
                }
            });
        }

        function renderStudentHeader(student) {
            document.getElementById('student-name').textContent = student.name;
            document.getElementById('student-xp').textContent = student.xp || 0;
            document.getElementById('student-money').textContent = student.money || 0;
        }

        function renderStudentShop(items, student) {
            const container = document.getElementById('student-shop-container');
            container.innerHTML = '';
            if (items.length === 0) { container.innerHTML = `<p class="text-gray-500 col-span-full">The shop is empty.</p>`; return; }
            items.forEach(item => {
                const canAfford = (student.money || 0) >= item.price;
                const itemEl = document.createElement('div');
                itemEl.className = `p-6 bg-white rounded-xl shadow-lg flex flex-col text-center transition-transform ${canAfford ? 'transform hover:scale-105' : ''}`;
                itemEl.innerHTML = `
                    <h3 class="text-xl font-bold text-gray-800 mb-2 flex-grow">${item.name}</h3>
                    <p class="text-3xl font-bold text-blue-600 mb-4">$${item.price}</p>
                    <button class="buy-item-btn w-full py-2 px-4 rounded-lg font-semibold text-white transition-colors ${canAfford ? 'bg-green-500 hover:bg-green-600' : 'bg-gray-400 cursor-not-allowed'}" ${!canAfford ? 'disabled' : ''}>Buy</button>
                `;
                container.appendChild(itemEl);

                if (canAfford) {
                    itemEl.querySelector('.buy-item-btn').addEventListener('click', async () => {
                        showLoading(true);
                        try {
                            const studentRef = getStudentDocRef(student.id);
                            const studentDoc = await getDoc(studentRef);
                            const currentMoney = studentDoc.data().money;

                            if (currentMoney >= item.price) {
                                await updateDoc(studentRef, { 
                                    money: currentMoney - item.price,
                                    lastPurchaseItemId: item.id 
                                });
                                await addDoc(getPurchaseHistoryCollectionRef(), {
                                    studentId: student.id,
                                    studentName: student.name,
                                    itemName: item.name,
                                    itemPrice: item.price,
                                    timestamp: serverTimestamp()
                                });
                                showModal("Purchase successful!");
                            } else {
                                showModal("You don't have enough money.");
                            }
                        } catch (error) {
                            console.error("Error purchasing item:", error);
                            showModal("Purchase failed. Please try again.");
                        } finally {
                            showLoading(false);
                        }
                    });
                }
            });
        }

        // --- AUTH & LOGIN LOGIC ---
        function logout() {
            if (studentDataUnsubscribe) studentDataUnsubscribe();
            if (shopDataUnsubscribe) shopDataUnsubscribe();
            if (allStudentsUnsubscribe) allStudentsUnsubscribe();
            if (purchaseHistoryUnsubscribe) purchaseHistoryUnsubscribe();
            signOut(auth);
        }
        
        async function signInWithGoogle() {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Google Sign-In failed:", error);
                showModal("Could not sign in with Google. Please try again.");
            }
        }
        
        async function signInAsTeacher() {
            // Teacher logs in anonymously for now. Security is handled by checking UID against 'teachers' collection.
            try {
                if (auth.currentUser && auth.currentUser.isAnonymous) {
                    // Already signed in as anonymous, just load dashboard
                    await loadTeacherDashboard();
                } else {
                    await signInAnonymously(auth);
                    // onAuthStateChanged will handle loading the dashboard
                }
            } catch (error) {
                console.error("Teacher anonymous sign-in failed:", error);
            }
        }

        // --- EVENT LISTENERS & APP START ---
        document.addEventListener('DOMContentLoaded', () => {
            loginView = document.getElementById('login-view');
            studentView = document.getElementById('student-view');
            teacherView = document.getElementById('teacher-view');
            loadingOverlay = document.getElementById('loading-overlay');
            modal = document.getElementById('modal');
            modalMessage = document.getElementById('modal-message');
            modalClose = document.getElementById('modal-close');

            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            onAuthStateChanged(auth, async user => {
                showLoading(true);
                currentUser = user;
                if (user && !user.isAnonymous) {
                    // A real user (student) is signed in
                    await loadStudentDashboard(user.uid);
                } else if (user && user.isAnonymous) {
                    // Teacher is signed in anonymously
                    await loadTeacherDashboard();
                } else {
                    // No user signed in
                    showView(loginView);
                }
                showLoading(false);
            });
            
            modalClose.addEventListener('click', hideModal);
            document.getElementById('student-login-btn').addEventListener('click', signInWithGoogle);
            document.getElementById('teacher-login-btn').addEventListener('click', signInAsTeacher);
            document.querySelectorAll('.logout-btn').forEach(btn => btn.addEventListener('click', logout));
            
            document.getElementById('add-item-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const itemNameInput = document.getElementById('new-item-name');
                const itemPriceInput = document.getElementById('new-item-price');
                const name = itemNameInput.value.trim();
                const price = parseInt(itemPriceInput.value, 10);
                if (!name || isNaN(price) || price < 0) { showModal("Invalid item details."); return; }
                showLoading(true);
                try {
                    await addDoc(getShopCollectionRef(), { name, price });
                    itemNameInput.value = ''; itemPriceInput.value = '';
                } catch (error) {
                    console.error("Error adding item:", error);
                    showModal("Failed to add shop item.");
                } finally {
                    showLoading(false);
                }
            });
        });
    </script>
    <style> body { font-family: 'Inter', sans-serif; } .hidden { display: none; } </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-7xl">
        <!-- Login View -->
        <div id="login-view">
            <div class="max-w-md mx-auto mt-20 bg-white p-8 rounded-xl shadow-lg text-center">
                <h1 class="text-4xl font-bold text-gray-800 mb-6">Welcome to Classroom Rewards!</h1>
                <p class="text-gray-600 mb-8">Please sign in to continue.</p>
                <div class="flex flex-col space-y-4">
                    <button id="student-login-btn" class="w-full bg-blue-600 text-white font-bold py-4 px-4 rounded-lg hover:bg-blue-700 transition-colors text-xl flex items-center justify-center gap-3">
                        <svg class="w-6 h-6" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12s5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24s8.955,20,20,20s20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"></path><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.222,0-9.519-3.11-11.28-7.481l-6.522,5.025C9.505,39.556,16.227,44,24,44z"></path><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.574l6.19,5.238C42.022,36.218,44,30.668,44,24C44,22.659,43.862,21.35,43.611,20.083z"></path></svg>
                        Sign in with Google
                    </button>
                    <button id="teacher-login-btn" class="w-full bg-gray-700 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-800 transition-colors text-sm">Teacher Login</button>
                </div>
            </div>
        </div>

        <!-- Student View -->
        <div id="student-view" class="hidden">
            <header class="bg-white p-6 rounded-xl shadow-lg mb-8 flex flex-col sm:flex-row justify-between items-center">
                <h1 class="text-3xl font-bold text-gray-800">Welcome, <span id="student-name"></span>!</h1>
                <div class="flex items-center gap-6 mt-4 sm:mt-0">
                    <div class="text-center"><p class="text-sm text-gray-500">XP</p><p class="text-3xl font-bold text-green-500" id="student-xp">0</p></div>
                    <div class="text-center"><p class="text-sm text-gray-500">Money</p><p class="text-3xl font-bold text-blue-500" id="student-money">0</p></div>
                    <button class="logout-btn bg-red-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-600">Logout</button>
                </div>
            </header>
            <div>
                <h2 class="text-2xl font-bold text-gray-700 mb-6">Class Shop</h2>
                <div id="student-shop-container" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"></div>
            </div>
        </div>

        <!-- Teacher View -->
        <div id="teacher-view" class="hidden">
            <header class="bg-white p-6 rounded-xl shadow-lg mb-8 flex justify-between items-center">
                 <div>
                    <h1 class="text-3xl font-bold text-gray-800">Teacher Dashboard</h1>
                    <p id="teacher-uid-display" class="text-xs text-red-600 mt-2 bg-red-100 p-2 rounded-md"></p>
                </div>
                <button class="logout-btn bg-red-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-600">Logout</button>
            </header>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <section class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold text-gray-700 mb-4">Manage Students</h2>
                    <div id="teacher-student-list" class="space-y-4"></div>
                </section>
                <div class="space-y-8">
                    <section class="bg-white p-6 rounded-xl shadow-lg">
                        <h2 class="text-2xl font-bold text-gray-700 mb-4">Manage Shop</h2>
                        <div id="teacher-shop-list" class="space-y-4 mb-6"></div>
                        <form id="add-item-form" class="mt-6 pt-6 border-t">
                             <h3 class="text-lg font-semibold text-gray-700 mb-2">Add New Item</h3>
                             <div class="flex flex-col gap-2">
                                <input type="text" id="new-item-name" class="p-2 border rounded-md" placeholder="Item Name">
                                <input type="number" id="new-item-price" class="p-2 border rounded-md" placeholder="Price $">
                                <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600">Add Item</button>
                             </div>
                        </form>
                    </section>
                    <section class="bg-white p-6 rounded-xl shadow-lg">
                        <h2 class="text-2xl font-bold text-gray-700 mb-4">Purchase History</h2>
                        <div id="purchase-history-list" class="space-y-2 max-h-96 overflow-y-auto"></div>
                    </section>
                </div>
            </div>
        </div>
    </div>
    <div id="loading-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"><div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-white"></div></div>
    <div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"><div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center"><p id="modal-message" class="text-lg text-gray-800 mb-4"></p><button id="modal-close" class="bg-indigo-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-indigo-700">Close</button></div></div>
</body>
</html>
